---
title: "Logistic Regression"
subtitle: "<br><br> Introduction to Global Health Data Science"
author: "[Back to Website](https://sta198f2021.github.io/website/)"
date: "<br> Prof. Amy Herring"
output:
  xaringan::moon_reader:
    css: 
      - css/xaringan-themer.css
      - css/slides.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightLines: true
      highlightStyle: solarized-light
      countIncrementalSlides: false
---

```{r child = "../setup.Rmd"}
```


```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  comment = "#>",
  highlight = TRUE,
  fig.align = "center"
)
```




```{r packages, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(tidymodels)
```


class: middle

# Logistic Regression

---

### Data

We consider data from the Global Adult Tobacco Survey (GATS), which is designed to provide nationally-representative data on non-institutionalized people 15 years and older. This survey is a global standard for systematically monitoring adult tobacco use and is produced by the Centers for Disease Control (CDC) in collaboration with the World Health Organization (WHO), RTI International, and Johns Hopkins University.

China has the largest smoking population in the world and accounts for roughly 40% of tobacco consumption worldwide. We will focus on GATS data from China in 2018 (the most recent survey year), but note data from other countries are available from the [WHO's Microdata Repository](https://extranet.who.int/ncdsmicrodata/index.php/home).

---

```{r readdata}
gats <- readr::read_csv("data/gats_rev.csv")

gats$RESIDENCE=factor(gats$RESIDENCE,levels=c(1,2),labels=c("Urban","Rural"))
gats$PROVINCE=factor(gats$PROVINCE,levels=seq(1:31),labels=c("Beijing","Tianjin","Hebei","Shanxi","Neimenggu","Liaoning","Jilin","Heilongjiang","Shanghai","Jiangsu","Zhejiang","Anhui","Fujian","Jiangxi","Shangdong","Henan","Hubei","Hunan","Guangdong","Guangxi","Hainan","Chongqing","Sichuan","Guizhou","Yunnan","Xizang","Shaanxi","Gansu","Qinghai","Ningxia","Xinjiang"))
gats$REGION6=factor(gats$REGION6,levels=seq(1:6),labels=c("North","North-East","East","South-Central","South-West","North-West"))
gats$REGION3=factor(gats$REGION3,levels=seq(1:3),labels=c("East","Central","West"))
gats$GENDER=factor(gats$GENDER,levels=c(1,2),labels=c("Male","Female"))
gats$CURRENTSMOKE=factor(gats$CURRENTSMOKE,levels=c(1,2,7),labels=c("Yes","No","Don't Know"))
gats$EDUCATION=factor(gats$EDUCATION,levels=c(1,2,3,4,5,6,7,8,77,99),labels=c("None","Less than Primary School","Primary School","Less than Secondary School","Secondary School","High School","University","Postgraduate","Don't Know","Refused"))
gats$OCCUPATION=factor(gats$OCCUPATION,levels=c(1,2,3,4,5,6,7,8,9,10,77,99),labels=c("Farming","Government","Business","Teacher","Healthcare","Student","Soldier","Unemployed","Retired","Other","Don't Know","Refused"))
gats$HEARDOFECIG=factor(gats$HEARDOFECIG,levels=c(1,2,9),labels=c("Yes","No","Refused"))
gats$ECIGUSE=factor(gats$ECIGUSE,levels=c(1,2,3,9),labels=c("Daily","Less than Daily","Not at All","Refused"))
gats$TRYSTOP=factor(gats$TRYSTOP,levels=c(1,2,9),labels=c("Yes","No","Refused"))
gats$HOMESMOKERULES=factor(gats$HOMESMOKERULES,levels=c(1,2,3,4,7,9),labels=c("Allowed","Not Allowed but Exceptions","Never Allowed","No Rules","Don't Know","Refused"))
gats$SMOKESICK=factor(gats$SMOKESICK,levels=c(1,2,7,9),labels=c("Yes","No","Don't Know","Refused"))
gats$SMOKESICKBINARY=ifelse(gats$SMOKESICK=="Yes","Yes","No")
gats$SMOKECANCER=factor(gats$SMOKECANCER,levels=c(1,2,7,9),labels=c("Yes","No","Don't Know","Refused"))
#scale age into decades
gats$DECADES=gats$AGE/10
```

What's up with all that code? I don't want alphabetical order in plots of education or other somewhat ordered categorical variables, so I'm using the levels and labels commands to specify ordering in advance.

---

### Selected variables

<br>

.midi[
variable        | description
----------------|-------------
`CURRENTSMOKE`      |	yes, no, or don't know
`AGE` |	computed from date of birth
`EDUCATION`	          | highest level of education completed
`OCCUPATION` | occupation
`RESIDENCE` | urban or rural
`GENDER`	          | interviewer instructions were "Record gender from observation. Ask if necessary"; options for male, female, missing/NA
`SMOKESICKYES` | respondent believes cigarette smoking can make you sick
]

Other data are also available in the file. Sample survey weights are not included but should be used to obtain nationally-representative estimates (our estimates are fairly close for the quantities we consider today).
---


## Is Believing Smoking Makes You Sick Related to Smoking?

.panelset[
.panel[.panel-name[Plot]
```{r ref.label = "smokesick", echo = FALSE, warning = FALSE, out.width = "50%"}
```
]
.panel[.panel-name[Code]
```{r smokesick, fig.show = "hide"}
ggplot(gats, aes(x = SMOKESICKBINARY,
                 fill =CURRENTSMOKE)) +
  geom_bar() + 
  labs(x = 'Smoking Makes You Sick?',
       fill = 'Current Smoking') +
   scale_fill_manual(values = c("#E48957", "#071381","#07813e"))

```
]
]

---

## Is Gender Related to Smoking?

.panelset[
.panel[.panel-name[Plot]
```{r ref.label = "smokegender", echo = FALSE, warning = FALSE, out.width = "50%"}
```
]
.panel[.panel-name[Code]
```{r smokegender, fig.show = "hide"}
ggplot(gats, aes(x = GENDER,
                 fill =CURRENTSMOKE)) +
  geom_bar() + 
  labs(x = 'Gender',
       fill = "Current Smoking") +
   scale_fill_manual(values = c("#E48957", "#071381","#07813e"))

```
]
]

---

## Is Education Related to Smoking?

.panelset[
.panel[.panel-name[Plot]
```{r ref.label = "smokeed", echo = FALSE, warning = FALSE, out.width = "50%"}
```
]
.panel[.panel-name[Code]
```{r smokeed, fig.show = "hide"}
ggplot(gats, aes(x = EDUCATION,
                 fill = CURRENTSMOKE)) +
  geom_bar() +
  labs(x = 'Education',
       fill = "Current Smoking") +
  scale_fill_manual(values = c("#E48957", "#071381", "#07813e")) +
  theme(axis.text.x = element_text(angle = 45,hjust=1))

```
]
]

---

## Is Residence Related to Smoking?

.panelset[
.panel[.panel-name[Plot]
```{r ref.label = "smokeres", echo = FALSE, warning = FALSE, out.width = "50%"}
```
]
.panel[.panel-name[Code]
```{r smokeres, fig.show = "hide"}
ggplot(gats, aes(x = RESIDENCE,
                 fill = CURRENTSMOKE)) +
  geom_bar() +
  labs(x = 'Residence',
       fill = "Current Smoking") +
  scale_fill_manual(values = c("#E48957", "#071381", "#07813e")) 

```
]
]

---

## Is Occupation Related to Smoking?

.panelset[
.panel[.panel-name[Plot]
```{r ref.label = "smokeocc", echo = FALSE, warning = FALSE, out.width = "50%"}
```
]
.panel[.panel-name[Code]
```{r smokeocc, fig.show = "hide"}
ggplot(gats, aes(x = OCCUPATION,
                 fill = CURRENTSMOKE)) +
  geom_bar() +
  labs(x = 'OCCUPATION',
       fill = "Current Smoking") +
  scale_fill_manual(values = c("#E48957", "#071381", "#07813e")) +
  theme(axis.text.x = element_text(angle = 45,hjust=1))

```
]
]

---

## Is Age Related to Smoking?

.panelset[
.panel[.panel-name[Plot]
```{r ref.label = "smokeage", echo = FALSE, warning = FALSE, out.width = "50%"}
```
]


.panel[.panel-name[Code]
```{r smokeage, fig.show = "hide"}
library(ggridges)
gats %>%
  ggplot(aes(x = AGE, y = CURRENTSMOKE, fill = CURRENTSMOKE, color = CURRENTSMOKE)) +
  geom_density_ridges2(alpha = 0.5) +
  labs(
    x = "Age (years)", 
    y = "Current Smoking",
    title = "Age vs. Current Smoking"
    ) +
  guides(color = FALSE, fill = FALSE) +
  scale_fill_manual(values = c("#E48957", "#071381", "#07813e")) +
  scale_color_manual(values = c("#E48957", "#071381", "#07813e")) 
 


```
]
]

---

## Modelling smoking

- Age, gender, education, occupation, residence, and beliefs about effects of smoking might all be related to whether a person smokes. How do we come up with a model that will let us explore this relationship?

--
- For simplicity, we'll focus on age (in decades) (`DECADES`) as predictor, but the model we describe can be expanded to take multiple predictors as well.

---

## Don't Know What to Do About Don't Know

The "don't know" for current smoking category is complicated. Ideally, we would work with the survey leaders to understand whether "don't know" is a way to avoid saying "yes," an indicator of only occasional smoking, or something else. For now, we will drop it and just consider responses of people who endorsed either "Yes" or "No" on the current smoking variable.

```{r dropdk}
gatsbin <- gats %>%
  filter(CURRENTSMOKE != "Don't Know")
```

---



## Modelling Smoking

This isn't something we can reasonably fit a linear model to -- we need something different!

```{r echo=FALSE, out.width="70%"}
means <- gatsbin %>%
  group_by(CURRENTSMOKE) %>%
  summarise(mean_age = mean(AGE)) %>%
  mutate(group = 1)

ggplot(gatsbin, aes(x = AGE, y = CURRENTSMOKE, color = CURRENTSMOKE)) +
  geom_jitter(alpha = 0.2) +
  geom_line(data = means, aes(x = mean_age, y = CURRENTSMOKE, group = group), color = "black", size = 1.5) +
  labs(x = "Age (in years)", y = "Current Smoking") +
  scale_color_manual(values = c("#DEB4A0", "#CA235F")) +
  guides(color = FALSE)
```

---

## Framing the problem

- We can treat each outcome (smoking and not) as successes and failures arising from separate Bernoulli trials
  - Bernoulli trial: a random experiment with exactly two possible outcomes, "success" and "failure", in which the probability of success is the same every time the experiment is conducted

--
- Each Bernoulli trial can have a separate probability of success

$$ y_i âˆ¼ Bern(\pi_i) $$

--
- We can then use the predictor variables to model that probability of success, $\pi_i$

--
- We can't just use a linear model for $\pi_i$ (since $\pi_i$ must be between 0 and 1) but we can transform the linear model to have the appropriate range

---

## Generalized linear models

- This is a very general way of addressing many problems in regression and the resulting models are called **generalized linear models (GLMs)**

--
- Logistic regression is just one example

---

## Three characteristics of GLMs

All GLMs have the following three characteristics:

1. A probability distribution describing a generative model for the outcome variable

--
2. A linear model:
$$\eta_i = \beta_0 + \beta_1 X_{1,i} + \cdots + \beta_k X_{k,i}$$

--
3. A link function that relates the linear model to the parameter of the outcome distribution
  
---

class: middle

# Logistic regression

---

## Logistic regression

- Logistic regression is a GLM used to model a binary categorical outcome using numerical and categorical predictors

--
- To finish specifying the logistic model we just need to define a reasonable link function that connects $\eta_i$ to $\pi_i$: logit function

--
- **Logit function:** For $0\le \pi \le 1$

$$logit(\pi) = \log\left(\frac{\pi}{1-\pi}\right)$$



---

## Logit function, visualised

```{r echo=FALSE}
d <- tibble(p = seq(0.001, 0.999, length.out = 1000)) %>%
  mutate(logit_p = log(p/(1-p)))

ggplot(d, aes(x = p, y = logit_p)) + 
  geom_line() + 
  xlim(0,1) + 
  ylab("logit(p)") +
  labs(title = "logit(p) vs. p")
```

---

## Properties of the logit

- The logit function takes a value between 0 and 1 and maps it to a value between $-\infty$ and $\infty$

--
- Inverse logit (logistic) function:
$$g^{-1}(x) = \frac{\exp(x)}{1+\exp(x)} = \frac{1}{1+\exp(-x)}$$

--
- The inverse logit function takes a value between $-\infty$ and $\infty$ and maps it to a value between 0 and 1

--
- This formulation is also useful for interpreting the model, since the logit can be interpreted as the log odds of a success -- more on this later

---

## The logistic regression model

- Based on the three GLM criteria we have
  - $y_i \sim \text{Bern}(\pi_i)$
  - $\eta_i = \beta_0+\beta_1 x_{1,i} + \cdots + \beta_n x_{n,i}$
  - $\text{logit}(\pi_i) = \eta_i$

--
- From which we get

$$\pi_i = \frac{\exp(\beta_0+\beta_1 x_{1,i} + \cdots + \beta_k x_{k,i})}{1+\exp(\beta_0+\beta_1 x_{1,i} + \cdots + \beta_k x_{k,i})}$$
---

## Modeling smoking

In R we fit a GLM in the same way as a linear model except we

- specify the model with `logistic_reg()`
- use `"glm"` instead of `"lm"` as the engine 
- define `family = "binomial"` for the link function to be used in the model

--

```{r}
#using DECADES to get age scaled by 10 year intervals
smoke_fit <- logistic_reg() %>%
  set_engine("glm") %>%
  fit(CURRENTSMOKE ~ DECADES, data = gats, family = "binomial")

tidy(smoke_fit)
```

---

## Smoking model

```{r}
tidy(smoke_fit, conf.int=TRUE)
```

--
Model:
$$\log\left(\frac{\hat{\pi}_i}{1-\hat{\pi}_i}\right) = 1.20-0.0249\times \text{DECADES_i}$$
---

## P(smoking) for a person aged 20

$$\log\left(\frac{\hat{\pi_i}}{1-\hat{\pi_i}\right) = 1.20-0.0249\times 2$$
--
$$\frac{\hat{\pi_i}{1-\hat{\pi_i} = \exp(1.1502) = 3.1588 \rightarrow p = 3.1588 \times (1 - p)$$

--
$$p = 3.1588 - 3.1588p \rightarrow 4.1588p = 3.1588$$
--
$$p = 3.1588 / 4.1588 = 0.76$$

---

.question[
What is the probability that a person aged 30 smokes? What about a person aged 70?
]

--


.pull-left[
```{r smoke-predict-viz, echo=FALSE, out.width = "100%", fig.asp=0.5}
newdata <- tibble(
  num_char = c(2, 3, 7),
  color    = c("#A7D5E8", "#e9d968", "#8fada7"),
  shape    = c(22, 24, 23)
  )

y_hat <- predict(smoke_fit, newdata, type = "raw")
p_hat <- exp(y_hat) / (1 + exp(y_hat))

newdata <- newdata %>%
  bind_cols(
    y_hat = y_hat,
    p_hat = p_hat
  )

smoke_aug <- augment(smoke_fit$fit) %>%
  mutate(prob = exp(.fitted) / (1 + exp(.fitted)))

ggplot(smoke_aug, aes(x = DECADES)) +
  geom_point(aes(y = as.numeric(CURRENTSMOKE)-1, color = CURRENTSMOKE), alpha = 0.3) +
  scale_color_manual(values = c("#DEB4A0", "#CA235F")) +
  scale_y_continuous(breaks = c(0, 1)) +
  guides(color = FALSE) +
  geom_line(aes(y = prob)) +
  geom_point(data = newdata, aes(x = DECADES, y = p_hat), 
             fill = newdata$color, shape = newdata$shape, 
             stroke = 1, size = 6) +
  labs(
    x = "Age (in decades)",
    y = "Smoking status", 
    title = "Smoking vs. Age"
  )
```
]
.pull-right[
- .light-blue[`r paste0(newdata$num_char[1], "K chars: P(smoke) = ", round(newdata$p_hat[1], 2))`]
- .yellow[`r paste0(newdata$num_char[2], "K chars, P(smoke) = ", round(newdata$p_hat[2], 2))`]
- .green[`r paste0(newdata$num_char[3], "K chars, P(smoke) = ", round(newdata$p_hat[3], 2))`]
]




